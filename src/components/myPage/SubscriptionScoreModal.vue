<script setup>
import { reactive } from 'vue';

import { useMyPageStore } from '@/stores/mypage';
import { useAuthStore } from '@/stores/auth';
import { storeToRefs } from 'pinia';

const store = useMyPageStore();
const { userInfo } = storeToRefs(store);

const authStore = useAuthStore();
const { token } = storeToRefs(authStore);

const emit = defineEmits(['close', 'calculated']);

const questions = reactive([
  {
    label: 'Î¨¥Ï£ºÌÉù Í∏∞Í∞Ñ',
    selected: '',
    options: [
      '30ÏÑ∏ ÎØ∏Îßå ÎØ∏Ìòº Î¨¥Ï£ºÌÉùÏûê (0Ï†ê)',
      '1ÎÖÑ ÎØ∏Îßå (2Ï†ê)',
      '1ÎÖÑ Ïù¥ÏÉÅ ~ 2ÎÖÑ ÎØ∏Îßå (4Ï†ê)',
      '2ÎÖÑ Ïù¥ÏÉÅ ~ 3ÎÖÑ ÎØ∏Îßå (6Ï†ê)',
      '3ÎÖÑ Ïù¥ÏÉÅ ~ 4ÎÖÑ ÎØ∏Îßå (8Ï†ê)',
      '4ÎÖÑ Ïù¥ÏÉÅ ~ 5ÎÖÑ ÎØ∏Îßå (10Ï†ê)',
      '5ÎÖÑ Ïù¥ÏÉÅ ~ 6ÎÖÑ ÎØ∏Îßå (12Ï†ê)',
      '6ÎÖÑ Ïù¥ÏÉÅ ~ 7ÎÖÑ ÎØ∏Îßå (14Ï†ê)',
      '7ÎÖÑ Ïù¥ÏÉÅ ~ 8ÎÖÑ ÎØ∏Îßå (16Ï†ê)',
      '8ÎÖÑ Ïù¥ÏÉÅ ~ 9ÎÖÑ ÎØ∏Îßå (18Ï†ê)',
      '9ÎÖÑ Ïù¥ÏÉÅ ~ 10ÎÖÑ ÎØ∏Îßå (20Ï†ê)',
      '10ÎÖÑ Ïù¥ÏÉÅ ~ 11ÎÖÑ ÎØ∏Îßå (22Ï†ê)',
      '11ÎÖÑ Ïù¥ÏÉÅ ~ 12ÎÖÑ ÎØ∏Îßå (24Ï†ê)',
      '12ÎÖÑ Ïù¥ÏÉÅ ~ 13ÎÖÑ ÎØ∏Îßå (26Ï†ê)',
      '13ÎÖÑ Ïù¥ÏÉÅ ~ 14ÎÖÑ ÎØ∏Îßå (28Ï†ê)',
      '14ÎÖÑ Ïù¥ÏÉÅ ~ 15ÎÖÑ ÎØ∏Îßå (30Ï†ê)',
      '15ÎÖÑ Ïù¥ÏÉÅ (32Ï†ê)',
    ],
  },
  {
    label: 'Î∂ÄÏñëÍ∞ÄÏ°± Ïàò',
    selected: '',
    options: [
      '0Î™Ö (5Ï†ê)',
      '1Î™Ö (10Ï†ê)',
      '2Î™Ö (15Ï†ê)',
      '3Î™Ö (20Ï†ê)',
      '4Î™Ö (25Ï†ê)',
      '5Î™Ö (30Ï†ê)',
      '6Î™Ö Ïù¥ÏÉÅ (35Ï†ê)',
    ],
  },
  {
    label: 'Ï≤≠ÏïΩÌÜµÏû• Í∞ÄÏûÖÍ∏∞Í∞Ñ',
    selected: '',
    options: [
      'Í∞ÄÏûÖ Ïïà Ìï® (0Ï†ê)',
      '6Í∞úÏõî ÎØ∏Îßå (1Ï†ê)',
      '6Í∞úÏõî Ïù¥ÏÉÅ ~ 1ÎÖÑ ÎØ∏Îßå (2Ï†ê)',
      '1ÎÖÑ Ïù¥ÏÉÅ ~ 2ÎÖÑ ÎØ∏Îßå (3Ï†ê)',
      '2ÎÖÑ Ïù¥ÏÉÅ ~ 3ÎÖÑ ÎØ∏Îßå (4Ï†ê)',
      '3ÎÖÑ Ïù¥ÏÉÅ ~ 4ÎÖÑ ÎØ∏Îßå (5Ï†ê)',
      '4ÎÖÑ Ïù¥ÏÉÅ ~ 5ÎÖÑ ÎØ∏Îßå (6Ï†ê)',
      '5ÎÖÑ Ïù¥ÏÉÅ ~ 6ÎÖÑ ÎØ∏Îßå (7Ï†ê)',
      '6ÎÖÑ Ïù¥ÏÉÅ ~ 7ÎÖÑ ÎØ∏Îßå (8Ï†ê)',
      '7ÎÖÑ Ïù¥ÏÉÅ ~ 8ÎÖÑ ÎØ∏Îßå (9Ï†ê)',
      '8ÎÖÑ Ïù¥ÏÉÅ ~ 9ÎÖÑ ÎØ∏Îßå (10Ï†ê)',
      '9ÎÖÑ Ïù¥ÏÉÅ ~ 10ÎÖÑ ÎØ∏Îßå (11Ï†ê)',
      '10ÎÖÑ Ïù¥ÏÉÅ ~ 11ÎÖÑ ÎØ∏Îßå (12Ï†ê)',
      '11ÎÖÑ Ïù¥ÏÉÅ ~ 12ÎÖÑ ÎØ∏Îßå (13Ï†ê)',
      '12ÎÖÑ Ïù¥ÏÉÅ ~ 13ÎÖÑ ÎØ∏Îßå (14Ï†ê)',
      '13ÎÖÑ Ïù¥ÏÉÅ ~ 14ÎÖÑ ÎØ∏Îßå (15Ï†ê)',
      '14ÎÖÑ Ïù¥ÏÉÅ ~ 15ÎÖÑ ÎØ∏Îßå (16Ï†ê)',
      '15ÎÖÑ Ïù¥ÏÉÅ (17Ï†ê)',
    ],
  },
]);

function extractScore(text) {
  const match = text.match(/\((\d+)Ï†ê\)/);
  return match ? parseInt(match[1]) : 0;
}

function calculateScore() {
  const isAllSelected = questions.every((q) => q.selected !== '');

  if (!isAllSelected) {
    alert('Î™®Îì† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
    return;
  }

  // üî• Ï¥ùÏ†ê Í≥ÑÏÇ∞ (number Î≥¥Ïû•)
  const total = questions.reduce((sum, q) => {
    const score = extractScore(q.selected);
    return sum + (typeof score === 'number' ? score : 0); // ÌòπÏãúÎùºÎèÑ ÏòàÏô∏ Î∞©ÏßÄ
  }, 0);

  console.log('üî• ÏµúÏ¢Ö Ï†êÏàò(total):', total, typeof total); // numberÏó¨Ïïº Ìï®

  // ‚úÖ Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏ (number Í∞í Î≥¥Ïû•)
  store.updateAdditionalPoint(total);

  emit('close');
}

const getAuthConfig = () => {
  if (token.value) {
    return {
      headers: {
        Authorization: `Bearer ${token.value}`,
      },
    };
  }
  return {};
};
</script>

<template>
  <div class="modal-backdrop">
    <div class="modal-box">
      <h4 class="fw-bold mb-4">Ï≤≠ÏïΩÍ∞ÄÏ†ê Í≥ÑÏÇ∞</h4>

      <div
        v-for="(question, index) in questions"
        :key="index"
        class="mb-4 d-flex align-items-start"
      >
        <!-- üîµ Q1, Q2 ÏïÑÏù¥ÏΩò -->
        <div
          class="me-3 rounded-circle bg-success text-white d-flex justify-content-center align-items-center"
          style="width: 36px; height: 36px; font-weight: bold"
        >
          Q{{ index + 1 }}
        </div>

        <div class="flex-grow-1">
          <label class="form-label fw-semibold">{{ question.label }}</label>
          <select class="form-select" v-model="question.selected">
            <option disabled value="">-- ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî --</option>
            <option v-for="(opt, i) in question.options" :key="i" :value="opt">
              {{ opt }}
            </option>
          </select>
        </div>
      </div>

      <div class="text-end mt-4">
        <button class="btn btn-outline-secondary me-2" @click="$emit('close')">
          Ï∑®ÏÜå
        </button>
        <button class="btn btn-success" @click="calculateScore">Í≥ÑÏÇ∞</button>
      </div>
    </div>
  </div>
</template>

<style scoped>
.modal-backdrop {
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.4);
  z-index: 1050;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-box {
  background: white;
  border-radius: 12px;
  padding: 2rem;
  width: 480px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

select.form-select {
  padding-left: 0.75rem;
}
</style>
